<div>
  <span class="stage-tags"
    >Workflow Type<span class="align-workflow-colon">:</span></span
  >
  <mat-form-field id="workflow-select-field" class="workflow-type-dd">
    <mat-select
      [(ngModel)]="selectedWorkflowType"
      (ngModelChange)="getWorkflowType()"
    >
      <mat-option
        id="wf-option"
        *ngFor="let wType of workflowTypes"
        [value]="wType.value"
      >
        {{ wType.viewValue }}
      </mat-option>
    </mat-select>
  </mat-form-field>
</div>

<div class="collapse-container">
  <span class="stage-action-collapse-text">Collapse All</span
  ><mat-slide-toggle
    (change)="collapseAllStages($event.checked)"
    disableRipple="true"
    [color]="primaryColor"
  ></mat-slide-toggle>
</div>

<div class="right-align-searchbox">
  <form>
    <mat-form-field
      id="mat-search"
      floatLabel="never"
      class="mat-typography full-width"
    >
      <img
        matPrefix
        src="assets/imgs/search-2.svg"
        alt="search-icon"
        class="new-search-icon"
      />
      <input
        matInput
        placeholder="Search"
        type="search"
        (keyup)="search($event)"
        name="test"
        [(ngModel)]="searchKey"
      />
    </mat-form-field>
  </form>
</div>

<div class="drag-drop-parent">
  <div
    cdkDropList
    [cdkDropListData]="stages"
    (cdkDropListDropped)="dropGroup($event)"
  >
    <!-- <div
      class="templates__inner__wrapper"
      *ngFor="let stage of stages | search: stage.searchKey; let i = index"
      cdkDropListGroup
      cdkDrag
      [cdkDragData]="stage"
    > -->
    <div
      class="templates__inner__wrapper"
      *ngFor="let stage of stages; let i = index"
      cdkDropListGroup
      cdkDrag
      [cdkDragData]="stage"
    >
      <!-- template list strats -->
      <div class="template-list-wrapper">
        <div>
          <div id="stage-header" class="template__row">
            <div class="template-name">
              <div
                class="group-drag"
                [ngClass]="{ 'do-not-show': !stage.drag }"
              >
                <img
                  style="cursor: move;"
                  src="assets/imgs/dragIcon-2.svg"
                  alt=""
                />
              </div>
              <!-- <div
                [ngClass]="{ collapsed: stage.collapsed }"
                (click)="openGroupLevelActions(stage)"
                class="accordian"
              > -->
              <div [ngClass]="{ collapsed: stage.collapsed }" class="accordian">
                <img
                  style="
                    width: 24px;
                    height: 24px;
                    position: relative;
                    top: 2px;
                  "
                  src="assets/imgs/chevron-down.svg"
                  alt=""
                  (click)="stage.collapsed = !stage.collapsed"
                />
                <!-- <div class="group-level-actions">
                  <div
                    (click)="stage.collapsed = true"
                    *ngIf="!stage.collapsed"
                  >
                    Collapse
                  </div>
                  <div
                    (click)="stage.collapsed = false"
                    *ngIf="stage.collapsed"
                  >
                    Expand
                  </div>
                  <div (click)="deleteGroup(stage)">Delete</div>
                </div> -->
              </div>
              <!-- group level actions ends -->

              <div
                class="group-name-wrapper"
                (mouseenter)="groupNameEnter(stage)"
                (mouseleave)="stage.edit = false"
              >
                <div class="group-name common-text">
                  {{ stage.name }}
                </div>
              </div>
            </div>
            <div *ngIf="!stage.collapsed" class="status-section">
              <span
                [ngClass]="{
                  'common-text-mobile': isMobile,
                  'common-text': !isMobile
                }"
                style="margin-right: 8px;"
                >Status:
              </span>
              <span
                class="badge badge-pill badge-custom"
                [ngStyle]="setBadgeBgColor(stage.state)"
                >{{ stage.state }}</span
              >
            </div>
            <div *ngIf="!stage.collapsed" class="progress-section">
              <span
                [ngClass]="{
                  'common-text-mobile': isMobile,
                  'common-text': !isMobile
                }"
                style="margin-right: 8px;"
                >Progress:
              </span>
              <mat-progress-bar
                style="width: 4.375em;"
                value="{{ stage.progressPercentage }}"
              ></mat-progress-bar>
              <span
                [ngClass]="{
                  'medium-text-mobile': isMobile,
                  'medium-text': !isMobile
                }"
                style="margin-left: 8px; min-width: fit-content;"
                >{{ stage.progressPercentage }} %</span
              >
            </div>
            <img
              class="stage-option"
              [ngStyle]="alignStageOption(stage.collapsed)"
              src="assets/imgs/vEllipsis.svg"
              alt="stage-options"
            />

            <div *ngIf="!stage.collapsed" class="stage-list-subheader">
              <div class="stage-name-width">
                <span
                  [ngClass]="{
                    'medium-text-mobile': isMobile,
                    'medium-text': !isMobile
                  }"
                  style="font-family: LatoSemiBold; color: var(--grayed-text);"
                  >Name</span
                >
              </div>
              <div style="display: flex;" *ngIf="!isMobile">
                <div style="width: 7.143em;">
                  <span
                    class="medium-text"
                    style="
                      font-family: LatoSemiBold;
                      color: var(--grayed-text);
                    "
                    >Plugin</span
                  >
                </div>
                <div
                  style="width: 7.143em;"
                  *ngIf="getWorkflowType() === 'time'"
                >
                  <span
                    class="medium-text"
                    style="
                      font-family: LatoSemiBold;
                      color: var(--grayed-text);
                    "
                    >Start Date</span
                  >
                </div>
                <div
                  style="width: 7.143em;"
                  *ngIf="getWorkflowType() === 'time'"
                >
                  <span
                    class="medium-text"
                    style="
                      font-family: LatoSemiBold;
                      color: var(--grayed-text);
                    "
                    >End Date</span
                  >
                </div>
                <div
                  style="width: 7.143em;"
                  *ngIf="getWorkflowType() === 'trigger'"
                >
                  <span
                    class="medium-text"
                    style="
                      font-family: LatoSemiBold;
                      color: var(--grayed-text);
                    "
                    >Trigger</span
                  >
                </div>
                <div style="width: 7.143em;">
                  <span
                    class="medium-text"
                    style="
                      font-family: LatoSemiBold;
                      color: var(--grayed-text);
                    "
                    >Status</span
                  >
                </div>
                <div style="width: 7.143em;">
                  <span
                    class="medium-text"
                    style="
                      font-family: LatoSemiBold;
                      color: var(--grayed-text);
                    "
                    >Progress</span
                  >
                </div>
              </div>
              <button
                class="stage-btn"
                mat-button
                [matMenuTriggerFor]="stageDropdown"
              >
                <img src="assets/imgs/vEllipsis.svg" alt="Stage Settings" />
              </button>
              <mat-menu
                id="stage-dd"
                #stageDropdown="matMenu"
                xPosition="before"
                yPosition="below"
              >
                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    padding-left: 12px;
                  "
                >
                  <mat-checkbox (click)="onCheck($event)">Service</mat-checkbox>
                  <mat-checkbox (click)="onCheck($event)">Action</mat-checkbox>
                </div>
              </mat-menu>
            </div>
          </div>
          <!-- cdkdroplist for template re ordering among and across groups -->
          <div
            *ngIf="!stage.collapsed"
            cdkDropList
            id="{{ stage.id }}"
            [cdkDropListData]="stage.data.taskTypes[0].tasks"
            (cdkDropListDropped)="drop($event)"
            [cdkDropListConnectedTo]="getConnectedList()"
          >
            <div
              class="row-items template__row item"
              [ngClass]="{ selected: stage.selected }"
              (click)="rowClick(task)"
              *ngFor="let task of tasks"
              cdkDrag
            >
              <div class="template-name">
                <!-- template level actions starts -->
                <!-- <div class="row-starter">
                  <div (click)="$event.stopPropagation()" class="accordian">
                    <img src="assets/imgs/chevron-down.svg" alt="" />
                    <div class="group-level-actions">
                      <div (click)="deleteTemplate(stage, task)">
                        Delete
                      </div>
                    </div>
                  </div>
                </div> -->
                <!-- template level actions starts -->

                <!-- <div class="grid-start-line border-white"></div> -->
                <div class="border-white template-name-main">
                  <span
                    [ngClass]="{
                      'mobile-text': isMobile,
                      'common-text': !isMobile
                    }"
                    class="cell-text"
                    >{{ task.name }}</span
                  >
                </div>
              </div>
              <div style="display: flex;">
                <div
                  *ngIf="!isMobile"
                  class="flex-center"
                  style="width: 100px; margin-left: 8px;"
                >
                  <span class="cell-text common-text">{{ task.plugin }}</span>
                </div>
                <div *ngIf="!isMobile">
                  <div
                    *ngIf="getWorkflowType() === 'time'"
                    class="border-white template-start flex-center"
                    style="margin-left: 20px;"
                  >
                    <span class="cell-text common-text">{{
                      task.startDate
                    }}</span>
                  </div>
                </div>
                <div *ngIf="!isMobile">
                  <div
                    *ngIf="getWorkflowType() === 'time'"
                    class="border-white template-end flex-center"
                  >
                    <span class="cell-text common-text">{{
                      task.endDate
                    }}</span>
                  </div>
                </div>
                <div *ngIf="!isMobile">
                  <div
                    *ngIf="getWorkflowType() === 'trigger'"
                    class="border-white template-end flex-center"
                  >
                    <span class="cell-text common-text">{{
                      task.trigger
                    }}</span>
                  </div>
                </div>
                <div
                  *ngIf="!isMobile"
                  class="border-white template-status"
                  [ngClass]="getStatusClass(task)"
                  (mouseleave)="task.showStatus = false"
                  (click)="showStatuses($event, task)"
                >
                  <!-- <span
                    class="cell-text"
                    style="color: #fff; text-transform: capitalize;"
                    >{{ task.status }}</span
                  > -->
                  <span
                    class="badge badge-pill badge-custom"
                    [ngStyle]="setBadgeBgColor(task.status)"
                    >{{ task.status }}</span
                  >
                  <!-- template status start -->
                  <div class="status-dropdown">
                    <div
                      (click)="changeStatus(task, 'Working on it')"
                      class="status__list__item status-yellow"
                    >
                      Working on it
                    </div>
                    <div
                      (click)="changeStatus(task, 'Done')"
                      class="status__list__item status-green"
                    >
                      Done
                    </div>
                    <div
                      (click)="changeStatus(task, 'Stuck')"
                      class="status__list__item status-red"
                    >
                      Stuck
                    </div>
                    <div
                      (click)="changeStatus(task, '')"
                      class="status__list__item"
                    ></div>
                  </div>
                  <!-- template status end -->
                </div>
                <div
                  *ngIf="!isMobile"
                  class="flex-center"
                  style="margin-left: 1vw;"
                >
                  <mat-progress-bar
                    style="width: 57px;"
                    value="{{ task.progressPercentage }}"
                  ></mat-progress-bar>
                  <span
                    class="medium-text"
                    style="margin-left: 8px; min-width: fit-content;"
                    >{{ task.progressPercentage }} %</span
                  >
                </div>
                <div class="right-options">
                  <img
                    class="set-margin-right"
                    src="assets/imgs/delete.svg"
                    alt="delete"
                  />
                  <img src="assets/imgs/vEllipsis.svg" alt="settings" />
                </div>
              </div>
            </div>
            <!-- <div class="template__row item editor-row"> -->
            <div class="template__row item row-items">
              <!-- add new template start -->
              <div class="template-name">
                <!-- <div class="row-starter"></div>
                <div class="grid-start-line border-white"></div> -->
                <!-- <div class="border-white template-name-main">
                  <input
                    (focus)="stage.showAdd = true"
                    (focusout)="inputFocusOut($event, stage)"
                    class="template-add"
                    (keydown.enter)="openDialog(addTaskModal)"
                    [(ngModel)]="stage.newTemplate"
                    type="text"
                    placeholder="+ Add"
                  />
                </div>
                <div
                  *ngIf="stage.showAdd"
                  (click)="openDialog(addTaskModal)"
                  class="template-add-button"
                >
                  Add
                </div> -->
                <span
                  class="common-text"
                  style="color: var(--primary-light); margin: auto 14px;"
                  (click)="openDialog(addTaskModal)"
                  >+ Add New Task</span
                >
              </div>
              <!-- add new template end -->
            </div>
          </div>
        </div>
      </div>

      <!-- template list ends -->
    </div>
  </div>
</div>

<ng-template #addTaskModal>
  <div class="modal-header">
    <h4 class="pull-left">Create New Task</h4>
  </div>
  <div class="modal-body">
    <!-- modal body -->
    <mat-tab-group [@.disabled]="true" class="mat-typography">
      <mat-tab label="General">
        <form [formGroup]="firstFormGroup" style="margin-top: 24px;">
          <mat-form-field class="example-full-width">
            <mat-label>Task Name</mat-label>
            <input
              matInput
              placeholder="Enter task name"
              value="Create Instance"
            />
          </mat-form-field>
          <mat-form-field class="example-full-width">
            <mat-label>Description</mat-label>
            <input
              matInput
              placeholder="Enter task description"
              value="Installation Configuration"
            />
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Plugin</mat-label>
            <mat-select
              [(ngModel)]="plugins[0].value"
              [ngModelOptions]="{ standalone: true }"
            >
              <mat-option *ngFor="let plugin of plugins" [value]="plugin.value">
                {{ plugin.viewValue }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Service</mat-label>
            <mat-select
              [(ngModel)]="services[0].value"
              [ngModelOptions]="{ standalone: true }"
            >
              <mat-option
                *ngFor="let service of services"
                [value]="service.value"
              >
                {{ service.viewValue }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Action</mat-label>
            <mat-select
              [(ngModel)]="actions[0].value"
              [ngModelOptions]="{ standalone: true }"
            >
              <mat-option *ngFor="let action of actions" [value]="action.value">
                {{ action.viewValue }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Account</mat-label>
            <mat-select
              [(ngModel)]="accounts[0].value"
              [ngModelOptions]="{ standalone: true }"
            >
              <mat-option
                *ngFor="let account of accounts"
                [value]="account.value"
              >
                {{ account.viewValue }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </form>
      </mat-tab>
      <mat-tab label="Input">
        <form [formGroup]="secondFormGroup" style="margin-top: 24px;">
          <mat-form-field class="example-half-width">
            <mat-label>Instance Name</mat-label>
            <input
              matInput
              placeholder="Enter Instance Name"
              value="$stage.task.instance"
            />
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Type</mat-label>
            <mat-select
              [(ngModel)]="types[0].value"
              [ngModelOptions]="{ standalone: true }"
            >
              <mat-option *ngFor="let type of types" [value]="type.value">
                {{ type.viewValue }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>VPC</mat-label>
            <input matInput placeholder="Enter VPC" value="VPC-Ohio" />
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Subnet</mat-label>
            <input matInput placeholder="Enter Subnet" value="SMR - 123214" />
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Security</mat-label>
            <input matInput placeholder="Enter Security" value="SMR Group" />
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Security Allowed</mat-label>
            <input
              matInput
              placeholder="Enter Security Allowed"
              value="SMR - 1233214"
            />
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>AMI</mat-label>
            <input matInput placeholder="Enter AMI" value="AMI - lkiik" />
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>Key</mat-label>
            <input matInput placeholder="Enter Key" value="KEY_SMR" />
          </mat-form-field>
        </form>
      </mat-tab>
      <mat-tab label="Output">
        <form [formGroup]="thirdFormGroup" style="margin-top: 24px;">
          <mat-form-field class="example-half-width">
            <mat-label>Instance Name</mat-label>
            <input matInput value="$stage.task.instance" />
          </mat-form-field>
          <mat-form-field class="example-half-width">
            <mat-label>IP</mat-label>
            <input matInput value="198.28.10.11" />
          </mat-form-field>
          <mat-form-field class="example-full-width">
            <mat-label>Description</mat-label>
            <input matInput value="Some Description comes here." />
          </mat-form-field>
        </form>
      </mat-tab>
    </mat-tab-group>
    <!-- end of modal body -->
  </div>
  <div class="modal-footer">
    <mat-dialog-actions>
      <button mat-flat-button (click)="dialog.closeAll()">Cancel</button>
      <button
        mat-flat-button
        color="primary"
        (click)="dialog.closeAll()"
        cdkFocusInitial
      >
        Create
      </button>
    </mat-dialog-actions>
  </div>
</ng-template>
